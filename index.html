<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebXR Tarot Reading</title>
    <meta name="description" content="A WebXR tarot reading application with hand tracking for Meta Quest 3">
    
    <style>
        .a-loader-title {
            color: #9370DB;
            font-family: 'Arial', sans-serif;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 9999;
        }

        #loading-progress {
            font-size: 24px;
            margin: 20px;
            color: #9370DB;
        }

        #loading-message {
            font-size: 18px;
            color: #ffffff;
            text-align: center;
            max-width: 80%;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #9370DB;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- WebXR Feature Detection -->
    <script>
        async function checkWebXRSupport() {
            // Check if running in Quest Browser
            const isQuestBrowser = /OculusBrowser/i.test(navigator.userAgent);
            console.log('Browser detection:', isQuestBrowser ? 'Quest Browser detected' : 'Not Quest Browser');

            // If not Quest browser, give more time for WebXR to initialize
            const initializationDelay = isQuestBrowser ? 0 : 2000;

            // Update loading message
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.textContent = 'Checking WebXR compatibility...';
            }

            try {
                // Wait for potential delayed WebXR initialization
                await new Promise(resolve => setTimeout(resolve, initializationDelay));

                if (typeof navigator.xr === 'undefined') {
                    throw new Error('WebXR API not found');
                }

                // Check for immersive-vr support
                const supported = await navigator.xr.isSessionSupported('immersive-vr');
                if (!supported) {
                    throw new Error('Immersive VR not supported');
                }

                console.log('WebXR supported and ready');
                if (loadingMessage) {
                    loadingMessage.textContent = 'WebXR supported! Loading assets...';
                }

                // Proceed with asset loading
                await window.AssetLoader.preloadAll();

                // Hide loading screen after successful loading
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }

            } catch (error) {
                console.error('WebXR Error:', error);
                
                // Only redirect to fallback if not on Quest browser
                if (!isQuestBrowser) {
                    window.location.href = 'fallback.html';
                } else {
                    // For Quest browser, retry after a delay
                    console.log('Retrying WebXR initialization...');
                    setTimeout(checkWebXRSupport, 2000);
                }
            }
        }

        // Wait for DOM to be ready before checking WebXR
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking WebXR support...');
            checkWebXRSupport();
        });
    </script>
    
    <!-- Error Logging -->
    <script>
        window.addEventListener('error', function(event) {
            // Create a visible error display
            var errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '10px';
            errorDiv.style.left = '10px';
            errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
            errorDiv.style.color = 'white';
            errorDiv.style.padding = '10px';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.maxWidth = '80%';
            errorDiv.style.wordBreak = 'break-word';
            errorDiv.textContent = 'Error: ' + event.message + ' at ' + event.filename + ':' + event.lineno;
            document.body.appendChild(errorDiv);
            
            console.error('Error:', event.message, 'at', event.filename, ':', event.lineno);
            return false;
        });
        
        // Log when A-Frame scene is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            var scene = document.querySelector('a-scene');
            if (scene) {
                scene.addEventListener('loaded', function() {
                    console.log('A-Frame scene loaded successfully');
                    
                    // Create a visible success message
                    var successDiv = document.createElement('div');
                    successDiv.style.position = 'fixed';
                    successDiv.style.top = '10px';
                    successDiv.style.left = '10px';
                    successDiv.style.backgroundColor = 'rgba(0, 255, 0, 0.8)';
                    successDiv.style.color = 'white';
                    successDiv.style.padding = '10px';
                    successDiv.style.zIndex = '9999';
                    successDiv.textContent = 'A-Frame scene loaded successfully';
                    document.body.appendChild(successDiv);
                });
                
                scene.addEventListener('renderstart', function() {
                    console.log('A-Frame rendering started');
                });
            } else {
                console.error('A-Frame scene not found');
            }
        });
    </script>
    
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    
    <!-- A-Frame Components -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/super-hands@3.0.3/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    
    <!-- Hand Tracking Components -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-hand-tracking-controls-component@0.0.7/dist/aframe-hand-tracking-controls-component.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="js/asset-loader.js"></script>
    <script src="js/card-system.js"></script>
    <script src="js/hand-tracking.js"></script>
    <script src="js/spreads.js"></script>
    
    <style>
        .a-loader-title {
            color: #9370DB;
            font-family: 'Arial', sans-serif;
        }
        
        /* Add a loading indicator */
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 9999;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="loading-screen">Loading...</div>

    <a-scene 
        webxr="optionalFeatures: hand-tracking, local-floor, hit-test, dom-overlay; overlayElement: #overlay;"
        physics="debug: false; gravity: 0 -9.8 0;"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;"
        loading-screen="dotsColor: #9370DB; backgroundColor: #1a1a2e"
        tarot-manager>
        
        <!-- Asset Management System -->
        <a-assets timeout="10000">
            <!-- Tarot Card Images -->
            <img id="card-back" src="assets/images/card-back.jpg">
            
            <!-- Major Arcana -->
            <img id="fool" src="assets/images/major-arcana/fool.jpg">
            <img id="magician" src="assets/images/major-arcana/magician.jpg">
            <img id="high-priestess" src="assets/images/major-arcana/high-priestess.jpg">
            <img id="empress" src="assets/images/major-arcana/empress.jpg">
            <img id="emperor" src="assets/images/major-arcana/emperor.jpg">
            <img id="hierophant" src="assets/images/major-arcana/hierophant.jpg">
            <img id="lovers" src="assets/images/major-arcana/lovers.jpg">
            <img id="chariot" src="assets/images/major-arcana/chariot.jpg">
            <img id="strength" src="assets/images/major-arcana/strength.jpg">
            <img id="hermit" src="assets/images/major-arcana/hermit.jpg">
            <img id="wheel-of-fortune" src="assets/images/major-arcana/wheel-of-fortune.jpg">
            <img id="justice" src="assets/images/major-arcana/justice.jpg">
            <img id="hanged-man" src="assets/images/major-arcana/hanged-man.jpg">
            <img id="death" src="assets/images/major-arcana/death.jpg">
            <img id="temperance" src="assets/images/major-arcana/temperance.jpg">
            <img id="devil" src="assets/images/major-arcana/devil.jpg">
            <img id="tower" src="assets/images/major-arcana/tower.jpg">
            <img id="star" src="assets/images/major-arcana/star.jpg">
            <img id="moon" src="assets/images/major-arcana/moon.jpg">
            <img id="sun" src="assets/images/major-arcana/sun.jpg">
            <img id="judgement" src="assets/images/major-arcana/judgement.jpg">
            <img id="world" src="assets/images/major-arcana/world.jpg">
            
            <!-- Sounds -->
            <audio id="card-flip" src="assets/sounds/card-flip.mp3"></audio>
            <audio id="card-shuffle" src="assets/sounds/card-shuffle.mp3"></audio>
            <audio id="ambient-music" src="assets/sounds/ambient-music.mp3" preload="auto"></audio>
            
            <!-- Mixins -->
            <a-mixin id="card" 
                     tarot-card
                     geometry="primitive: plane; width: 0.063; height: 0.11" 
                     material="shader: flat; side: double; transparent: true"
                     shadow="cast: true; receive: true"
                     animation__hover="property: position; dir: alternate; dur: 1000; easing: easeInOutSine; loop: true; startEvents: hover-start; pauseEvents: hover-end"
                     grabbable="constraintComponentName: physics-constraint"
                     hoverable
                     droppable></a-mixin>
                     
            <a-mixin id="button"
                     geometry="primitive: box; width: 0.15; height: 0.05; depth: 0.01"
                     material="color: #9370DB; opacity: 0.8"
                     text="align: center; color: white; width: 0.5"
                     hoverable
                     clickable></a-mixin>
                     
            <a-mixin id="position-marker"
                     geometry="primitive: plane; width: 0.063; height: 0.11"
                     material="color: #9370DB; opacity: 0.3; wireframe: true"
                     visible="false"></a-mixin>
        </a-assets>
        
        <!-- Environment -->
        <a-entity environment="preset: starry; groundColor: #1a1a2e; groundColor2: #2a2a4e; dressing: none; dressingAmount: 0; grid: none; fog: 0.7; dressingColor: #9370DB; skyType: gradient; skyColor: #1a1a2e; horizonColor: #2a2a4e;"></a-entity>
        
        <!-- Lighting -->
        <a-entity light="type: ambient; color: #9370DB; intensity: 0.3"></a-entity>
        <a-entity light="type: directional; color: #fff; intensity: 0.5; castShadow: true" position="1 1 1"></a-entity>
        <a-entity light="type: point; color: #9370DB; intensity: 0.8; distance: 5" position="0 2 0"></a-entity>
        
        <!-- Tarot Table -->
        <a-entity id="tarot-table" position="0 0.75 -0.5">
            <a-cylinder 
                radius="0.5" 
                height="0.05" 
                color="#4B0082" 
                shadow="cast: true; receive: true"
                static-body></a-cylinder>
            <a-cylinder 
                radius="0.1" 
                height="0.7" 
                position="0 -0.375 0" 
                color="#4B0082" 
                shadow="cast: true; receive: true"
                static-body></a-cylinder>
            <a-entity 
                position="0 0.03 0" 
                geometry="primitive: cylinder; radius: 0.48; height: 0.01" 
                material="color: #2a2a4e" 
                shadow="cast: true; receive: true"></a-entity>
        </a-entity>
        
        <!-- Deck Position -->
        <a-entity id="deck-position" position="0.3 0.83 -0.5" tarot-deck></a-entity>
        
        <!-- Spread Positions -->
        <a-entity id="spread-positions" position="0 0.83 -0.5" tarot-spread></a-entity>
        
        <!-- UI Elements -->
        <a-entity id="ui-panel" position="0 1.2 -0.8" rotation="-30 0 0">
            <a-entity id="shuffle-button" mixin="button" position="-0.2 0 0" text="value: Shuffle Deck; width: 0.5"></a-entity>
            <a-entity id="three-card-button" mixin="button" position="0 0 0" text="value: 3-Card Spread; width: 0.5"></a-entity>
            <a-entity id="celtic-cross-button" mixin="button" position="0.2 0 0" text="value: Celtic Cross; width: 0.5"></a-entity>
            <a-entity id="reset-button" mixin="button" position="0.4 0 0" text="value: Reset; width: 0.5"></a-entity>
        </a-entity>
        
        <!-- Card Meaning Display -->
        <a-entity id="card-meaning" 
                  position="0 1.5 -1" 
                  text="align: center; color: white; width: 1; wrapCount: 30; value: Select a spread and draw cards"
                  visible="true"></a-entity>
        
        <!-- Hand Tracking Controllers -->
        <a-entity id="left-hand" 
                  hand-tracking-controls="hand: left; modelStyle: highPoly; modelColor: #9370DB"
                  hand-tracking-extras
                  sphere-collider="objects: [grabbable]"
                  super-hands="colliderEvent: collisions; 
                              colliderEventProperty: els;
                              colliderEndEvent: collisions;
                              colliderEndEventProperty: clearedEls"></a-entity>
                              
        <a-entity id="right-hand" 
                  hand-tracking-controls="hand: right; modelStyle: highPoly; modelColor: #9370DB"
                  hand-tracking-extras
                  sphere-collider="objects: [grabbable]"
                  super-hands="colliderEvent: collisions; 
                              colliderEventProperty: els;
                              colliderEndEvent: collisions;
                              colliderEndEventProperty: clearedEls"></a-entity>
        
        <!-- Camera Rig -->
        <a-entity id="rig" position="0 1.6 0">
            <a-camera look-controls wasd-controls position="0 0 0"></a-camera>
        </a-entity>
    </a-scene>
    
    <!-- DOM Overlay for WebXR -->
    <div id="overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;">
        <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.5); color: white; padding: 10px; border-radius: 5px; text-align: center;">
            <p id="overlay-text">Use your hands to interact with the tarot cards</p>
        </div>
    </div>
    
    <script>
        // Hide loading indicator when scene is loaded
        document.querySelector('a-scene').addEventListener('loaded', function () {
            document.getElementById('loading-indicator').style.display = 'none';
        });
        
        // Update loading progress
        document.querySelector('a-assets').addEventListener('progress', function (evt) {
            const loadingProgress = document.getElementById('loading-progress');
            const progress = Math.floor(evt.detail.loadedPct);
            loadingProgress.textContent = `Loading assets: ${progress}%`;
        });
        
        // Fallback for loading indicator if scene takes too long
        setTimeout(function() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator && loadingIndicator.style.display !== 'none') {
                loadingIndicator.innerHTML += '<br>Loading is taking longer than expected. You may need to refresh the page.';
            }
        }, 15000);
        
        // Add VR button event listener
        document.querySelector('a-scene').addEventListener('enter-vr', function() {
            console.log('Entered VR mode');
            // Show a message when VR mode is entered
            const vrModeDiv = document.createElement('div');
            vrModeDiv.style.position = 'fixed';
            vrModeDiv.style.top = '50%';
            vrModeDiv.style.left = '50%';
            vrModeDiv.style.transform = 'translate(-50%, -50%)';
            vrModeDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            vrModeDiv.style.color = 'white';
            vrModeDiv.style.padding = '20px';
            vrModeDiv.style.borderRadius = '10px';
            vrModeDiv.style.zIndex = '9999';
            vrModeDiv.textContent = 'VR mode activated! Use your hands to interact with the tarot cards.';
            document.body.appendChild(vrModeDiv);
            
            // Remove the message after a few seconds
            setTimeout(function() {
                vrModeDiv.style.display = 'none';
            }, 3000);
        });
    </script>
</body>
</html> 